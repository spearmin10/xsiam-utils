{
    "sources": [
        {
            "#": "Random-Looking Domain Names",
            "operation": "internal.outbound",
            "type": "network",
            "src": "{_corp_client_segment_ip_prefix}.0/24",
            "src_user": null,
            "src_host": null,
            "src_domain": null,
            "dst": "public",
            "dst_port": 443,
            "ip_protocol": "tcp",
            "app_protocol": "https",
            "fw_action": "allow",
            "http": {
                "default": {
                    "resp_status": 200,
                    "resp_bytes": "{random.randint(2048, 1024 * 1024)}"
                },
                "dst": [
                    "https://www.{''.join(random.choices(string.ascii_lowercase + '_', k=8))}.{random.choice(['com','net','org'])}",
                    "https://{''.join(random.choices(string.ascii_lowercase + '_', k=16))}.{random.choice(['com','net','org'])}"
                ]
            },
            ".weights": 0.01
        },
        {
            "operation": "internal.outbound",
            "type": "network",
            "src": "{_corp_client_segment_ip_prefix}.0/24",
            "src_user": null,
            "src_host": null,
            "src_domain": null,
            "dst": "public",
            "dst_port": "25, 110, 143, 3389, 8080",
            "ip_protocol": "tcp",
            "fw_action": "drop"
        }
    ],
    "callables": {
        "Malicious_Email_To_User": {
            ".variables": {
                "internal_user": {
                    "types": "eval",
                    "value": "next((u for u in __users.values() if u.get('ip') == src_ip), {})"
                },
                "now_rfc1123_time": "{datetime.datetime.now(datetime.UTC).strftime('%a, %d %b %Y %H:%M:%S %z')}",
                "now_iso8601_time": "{datetime.datetime.now(datetime.UTC).isoformat(timespec='seconds').replace('+00:00', 'Z')}",
                "mta_host1_main": "{''.join(random.choices(string.ascii_uppercase, k=9))}{''.join(random.choices(string.digits, k=4))}",
                "mta_host2_main": "{''.join(random.choices(string.ascii_uppercase, k=9))}{''.join(random.choices(string.digits, k=4))}",
                "mta_host_sub": "{''.join(random.choices(string.ascii_uppercase, k=4))}{''.join(random.choices(string.digits, k=3))}",
                "attachment_sources": {
                    "types": "eval",
                    "value": [
                        {
                            "@odata.type": "'#microsoft.graph.fileAttachment'",
                            "@odata.mediaContentType": "'application/octet-stream'",
                            "id": "''.join(random.choices(string.ascii_lowercase, k=180))",
                            "lastModifiedDateTime": "now_iso8601_time",
                            "name": "'invoice.doc'",
                            "contentType": "'application/octet-stream'",
                            "size": 27479,
                            "isInline": false,
                            "contentId": "f\"{''.join(random.choices(string.ascii_uppercase, k=32))}@{mta_host_sub}.PROD.OUTLOOK.COM\"",
                            "contentLocation": null,
                            "hash_str": "'906b5f181c4ec865b9362702e4578ca7f8d30751b90af706f0f4faf16bb3f575'"
                        },
                        {
                            "@odata.type": "'#microsoft.graph.fileAttachment'",
                            "@odata.mediaContentType": "'application/octet-stream'",
                            "id": "''.join(random.choices(string.ascii_lowercase, k=180))",
                            "lastModifiedDateTime": "now_iso8601_time",
                            "name": "'invoice.xls'",
                            "contentType": "'application/octet-stream'",
                            "size": 52542,
                            "isInline": false,
                            "contentId": "f\"{''.join(random.choices(string.ascii_uppercase, k=32))}@{mta_host_sub}.PROD.OUTLOOK.COM\"",
                            "contentLocation": null,
                            "hash_str": "'814b6b5b2692a5376c5bb73c963bcfe47bc9ad25c598804dafd149fa92f77003'"
                        }
                    ]
                },
                "attachments": {
                    "types": "eval",
                    "value": "[random.choice(attachment_sources)]"
                },
                "sender_domain": "{random.choice(['x.co', 'vodpool.ga', 'mecofficial.com'])}",
                "sender_display_name": "{random.choice(['Ticket Center', 'Reservation'])}",
                "sender_account_name": "{''.join(random.choices(string.ascii_lowercase, k=10))}",
                "sender_email_address": "{sender_account_name}@{sender_domain}",
                "recipient_account_name": "{internal_user.get('user_name', '')}",
                "recipient_email_address": "{recipient_account_name}@{internal_user.get('external_domain', '')}",
                "internetmessageid": "<{''.join(random.choices(string.ascii_uppercase + string.digits, k=32))}@{sender_domain}>",
                "internetmessageheaders": [
                    {
                        "name": "Received",
                        "value": "from {mta_host1_main}.{mta_host_sub}.PROD.OUTLOOK.COM (2603:1096:400:2e5::9) by {mta_host2_main}.{mta_host_sub}.PROD.OUTLOOK.COM with HTTPS; {now_rfc1123_time}"
                    },
                    {
                        "name": "Content-Type",
                        "value": "application/ms-tnef"
                    },
                    {
                        "name": "Content-Transfer-Encoding",
                        "value": "binary"
                    },
                    {
                        "name": "From",
                        "value": "\"{sender_display_name}\" <{sender_email_address}>"
                    },
                    {
                        "name": "To",
                        "value": "{recipient_email_address}"
                    },
                    {
                        "name": "Importance",
                        "value": "low"
                    },
                    {
                        "name": "X-Priority",
                        "value": "5"
                    },
                    {
                        "name": "Date",
                        "value": "{now_rfc1123_time}"
                    },
                    {
                        "name": "Message-ID",
                        "value": "{internetmessageid}"
                    },
                    {
                        "name": "Accept-Language",
                        "value": "en-US"
                    },
                    {
                        "name": "Content-Language",
                        "value": "en-US"
                    },
                    {
                        "name": "X-MS-Has-Attach",
                        "value": "{'yes' if attachments else 'no'}"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-SCL",
                        "value": "1"
                    },
                    {
                        "name": "MIME-Version",
                        "value": "1.0"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-MessageDirectionality",
                        "value": "Originating"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-AuthSource",
                        "value": "{mta_host1_main}.{mta_host_sub}.PROD.OUTLOOK.COM"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-AuthAs",
                        "value": "Internal"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-AuthMechanism",
                        "value": "04"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-Network-Message-Id",
                        "value": "{uuid.uuid4()}"
                    },
                    {
                        "name": "X-MS-PublicTrafficType",
                        "value": "Email"
                    },
                    {
                        "name": "X-MS-TrafficTypeDiagnostic",
                        "value": "{mta_host1_main}:EE_|TY1P286MB3277:EE_|OS3P286MB1759:EE_"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-ExpirationStartTime",
                        "value": "{datetime.datetime.now(datetime.UTC).strftime('%a, %d %b %Y %H:%M:%S.%f')[:-2]} (UTC)"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-ExpirationStartTimeReason",
                        "value": "OriginalSubmit"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-ExpirationInterval",
                        "value": "1:00:00:00.0000000"
                    },
                    {
                        "name": "X-MS-Exchange-Organization-ExpirationIntervalReason",
                        "value": "OriginalSubmit"
                    },
                    {
                        "name": "X-MS-Office365-Filtering-Correlation-Id",
                        "value": "{uuid.uuid4()}"
                    },
                    {
                        "name": "X-MS-Exchange-Transport-Rules-Loop",
                        "value": "1"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-OriginalArrivalTime",
                        "value": "{datetime.datetime.now(datetime.UTC).strftime('%a, %d %b %Y %H:%M:%S.%f')[:-2]} (UTC)"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-FromEntityHeader",
                        "value": "Hosted"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-Id",
                        "value": "{uuid.uuid4()}"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-AuthSource",
                        "value": "{mta_host1_main}.{mta_host_sub}.PROD.OUTLOOK.COM"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-AuthAs",
                        "value": "Internal"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-Network-Message-Id",
                        "value": "{uuid.uuid4()}"
                    },
                    {
                        "name": "X-MS-Exchange-CrossTenant-MailboxType",
                        "value": "HOSTED"
                    },
                    {
                        "name": "X-MS-Exchange-Transport-EndToEndLatency",
                        "value": "00:00:01.7340127"
                    },
                    {
                        "name": "X-MS-Exchange-Processed-By-BccFoldering",
                        "value": "15.20.8251.004"
                    },
                    {
                        "name": "X-Microsoft-Antispam-Mailbox-Delivery",
                        "value": "ucf:0;jmr:0;auth:0;dest:I;ENG:(910001)(944506478)(944626604)(920097)(425001)(930097)(140003);"
                    }
                ],
                "weblink": "https://outlook.office365.com/owa/?ItemID={''.join(random.choices(string.ascii_lowercase, k=120))}&exvsurl=1&viewmodel=ReadMessageItem"
            },
            ".eval": {
                "log_params": "eval",
                "operation": "eval"
            },
            "operation": "'log' if bool(internal_user) else 'noop'",
            "type": "custom",
            "cef_version": "0",
            "cef_vendor": "msft",
            "cef_product": "o365_emails",
            "log_format": "json",
            "log_params": {
                "attachments": "attachments",
                "bccrecipients": [],
                "body": null,
                "categories": [],
                "ccrecipients": [],
                "changekey": "''.join(random.choices(string.ascii_lowercase, k=40))",
                "conversationid": "''.join(random.choices(string.hexdigits, k=80))",
                "conversationindex": "''.join(random.choices(string.hexdigits, k=54))",
                "createddatetime": "now_iso8601_time",
                "flag": {
                    "flagStatus": "'notFlagged'"
                },
                "from": {
                    "emailAddress": {
                        "name": "sender_display_name",
                        "address": "sender_email_address"
                    }
                },
                "hasattachments": "bool(attachments)",
                "id": "''.join(random.choices(string.hexdigits, k=150))",
                "importance": "'low'",
                "inferenceclassification": "'focused'",
                "internetmessageheaders": "internetmessageheaders",
                "internetmessageid": "internetmessageid",
                "isdeliveryreceiptrequested": false,
                "isdraft": false,
                "isread": false,
                "isreadreceiptrequested": false,
                "lastmodifieddatetime": "now_iso8601_time",
                "parentfolderid": "base64.b64encode(recipient_email_address.encode()).decode()",
                "receiveddatetime": "now_iso8601_time",
                "replyto": [],
                "sender": {
                    "emailAddress": {
                        "name": "sender_display_name",
                        "address": "sender_email_address"
                    }
                },
                "sentdatetime": "now_iso8601_time",
                "torecipients": [
                    {
                        "emailAddress": {
                            "name": "''",
                            "address": "recipient_email_address"
                        }
                    }
                ],
                "weblink": "weblink"
            }
        }
    },
    "jobs": [
        {
            "#": "Random-Looking Domain Names - Web Access",
            ".interval": "{random.randint(7200, 14400)}",
            ".variables": {
                "fqdn1": "www.{''.join(random.choices(string.ascii_lowercase + '_', k=8))}.{random.choice(['com','net','org'])}",
                "fqdn2": "{''.join(random.choices(string.ascii_lowercase + '_', k=16))}.{random.choice(['com','net','org'])}",
                "fqdn": "{random.choice([fqdn1, fqdn2])}",
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(1, 199)}"
            },
            "sources": {
                "operation": "internal.outbound",
                "type": "network",
                "src": "{src_ip}",
                "src_user": null,
                "src_host": null,
                "src_domain": null,
                "dst": "public",
                "dst_port": 443,
                "ip_protocol": "tcp",
                "app_protocol": "https",
                "fw_action": "allow",
                "http": {
                    "default": {
                        "resp_status": 200,
                        "resp_bytes": "{random.randint(2048, 1024 * 1024)}"
                    },
                    "dst": "https://{fqdn}"
                },
                ".wait": "{random.randint(0, 10)}",
                ".repeat": {
                    "eval": "params",
                    "count": 50
                }
            }
        },
        {
            "#": "DGA - Random Domain Name Queries",
            ".interval": "{random.randint(7200, 14400)}",
            ".variables": {
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(10, 14)}",
                "src_port": "{random.randint(10000, 65534)}",
                "domain": "{''.join(random.choices(string.ascii_lowercase, k=32))}.com",
                "host": "{''.join(random.choices(string.ascii_lowercase, k=4))}"
            },
            "sources": [
                {
                    ".call": {
                        "name": "Malicious_Email_To_User"
                    },
                    ".wait": 600
                },
                {
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_port": "{src_port}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{_corp_internal_dns_ip}",
                    "dst_port": 53,
                    "ip_protocol": "udp",
                    "app_protocol": "dns",
                    "fw_action": "allow",
                    "dns": {
                        "queries": {
                            "name": "{host}.{domain}",
                            "type": "A"
                        }
                    },
                    ".wait": 10
                },
                {
                    "operation": "log",
                    "type": "ngfw-threat",
                    "params": {
                        "subtype": "spyware",
                        "source_ip": "{src_ip}",
                        "source_user": null,
                        "source_port": "{src_port}",
                        "dest_ip": "{_corp_internal_dns_ip}",
                        "dest_port": 53,
                        "protocol": "udp",
                        "app": "dns-base",
                        "app_category": "networking",
                        "app_sub_category": "infrastructure",
                        "threat_name": "DGA:{host}.{domain}",
                        "threat_category": "dns-c2",
                        "direction": "client to server"
                    }
                }
            ]
        },
        {
            "#": "Uncommon SSH session",
            ".interval": "{random.randint(7200, 14400)}",
            "sources": {
                ".variables": {
                    "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(1, 199)}"
                },
                "operation": "internal.outbound",
                "type": "network",
                "src": "{src_ip}",
                "src_user": null,
                "src_host": null,
                "src_domain": null,
                "dst": "public",
                "dst_port": "22",
                "ip_protocol": "tcp",
                "fw_action": "drop"
            }
        },
        {
            "#": "DNS tunneling",
            ".interval": "{random.randint(43200, 86400)}",
            ".variables": {
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(10, 14)}",
                "dst_ip": "{_corp_internal_dns_ip}",
                "domain1": "{random.choice(['go0gie.com','pawevi.com','anyconnect.stream','bigip.stream','fortiweb.download','kaspersky.science','microtik.stream','owa365.bid','symanteclive.download','windowsdefender.win'])}",
                "domain2": "{''.join(random.choices(string.ascii_lowercase, k=4))}.{random.choice(['com','net','org','biz'])}"
            },
            "sources": [
                {
                    ".call": {
                        "name": "Malicious_Email_To_User"
                    },
                    ".wait": 600
                },
                {
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{dst_ip}",
                    "dst_port": 53,
                    "ip_protocol": "udp",
                    "app_protocol": "dns",
                    "fw_action": "allow",
                    "dns": {
                        "queries": [
                            {
                                "name": "{''.join(random.choices(string.ascii_lowercase, k=32))}.{domain1}",
                                "type": "A"
                            }
                        ]
                    },
                    ".repeat": 10000
                },
                {
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{dst_ip}",
                    "dst_port": 53,
                    "ip_protocol": "udp",
                    "app_protocol": "dns",
                    "fw_action": "allow",
                    "dns": {
                        "queries": [
                            {
                                "name": "{''.join(random.choices(string.ascii_lowercase, k=32))}.{domain2}",
                                "type": "TXT"
                            }
                        ]
                    },
                    ".repeat": 10000
                }
            ]
        },
        {
            "#": "Port Scan + SMB: User Password Brute Force Attempt",
            ".interval": "{random.randint(43200, 86400)}",
            ".variables": {
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(10, 14)}"
            },
            "sources": [
                {
                    ".call": {
                        "name": "Malicious_Email_To_User"
                    },
                    ".wait": 600
                },
                {
                    ".variables": {
                        "scan_range": {
                            "types": "eval",
                            "value": "({'dst_port': dst_port, 'o4': o4} for o4 in range(1, 199) for dst_port in range(1, 1024))"
                        }
                    },
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{_corp_server_segment_ip_prefix}.{o4}",
                    "dst_port": "{dst_port}",
                    "ip_protocol": "tcp",
                    "app_protocol": "incomplete",
                    "fw_action": "allow",
                    ".repeat": {
                        "iter_vars": "scan_range"
                    }
                },
                {
                    ".variables": {
                        "src_port": "{random.randint(10000, 65534)}",
                        "dst_ip": "{_corp_server_segment_ip_prefix}.{random.randint(1, 199)}"
                    },
                    ".next": {
                        "mode": "sequential",
                        "sources": [
                            {
                                "operation": "internal.outbound",
                                "type": "network",
                                "src": "{src_ip}",
                                "src_port": "{src_port}",
                                "src_user": null,
                                "src_host": null,
                                "src_domain": null,
                                "dst": "{dst_ip}",
                                "dst_port": "445",
                                "ip_protocol": "tcp",
                                "app_protocol": "incomplete",
                                "fw_action": "allow"
                            },
                            {
                                "operation": "log",
                                "type": "ngfw-threat",
                                "params": {
                                    "subtype": "vulnerability",
                                    "source_ip": "{src_ip}",
                                    "source_user": null,
                                    "source_port": "{src_port}",
                                    "dest_ip": "{dst_ip}",
                                    "dest_port": "445",
                                    "protocol": "tcp",
                                    "app": "ms-ds-smbv3",
                                    "app_category": "business-systems",
                                    "app_sub_category": "storage-backup",
                                    "threat_name": "SMB: User Password Brute Force Attempt(40004)",
                                    "threat_category": "brute-force",
                                    "direction": "client-to-server",
                                    ".wait": 10
                                }
                            },
                            {
                                "operation": "log",
                                "type": "ngfw-threat",
                                "params": {
                                    "subtype": "vulnerability",
                                    "source_ip": "{src_ip}",
                                    "source_user": null,
                                    "source_port": "{src_port}",
                                    "dest_ip": "{dst_ip}",
                                    "dest_port": "445",
                                    "protocol": "tcp",
                                    "app": "ms-ds-smbv3",
                                    "app_category": "business-systems",
                                    "app_sub_category": "storage-backup",
                                    "threat_name": "Windows SMB Login Attempt",
                                    "threat_category": "brute-force",
                                    "direction": "client-to-server"
                                }
                            }
                        ]
                    },
                    ".repeat": {
                        "eval": "vars",
                        "count": "{random.randint(10, 20)}"
                    }
                },
                {
                    "operation": "log",
                    "type": "windows-event-ad",
                    "src_ip": "{src_ip}",
                    "dst_host": "slp-ad.corp.cortex.lan",
                    "event_id": 4771,
                    ".repeat": 50
                }
            ]
        },
        {
            "#": "Malicious PowerShell Script [No Proxy]",
            ".interval": "{random.randint(43200, 86400)}",
            ".variables": {
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(32, 36)}",
                "src_port": "{random.randint(10000, 65534)}",
                "dst_ip": "185.199.110.133"
            },
            "sources": [
                {
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_port": "{src_port}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{dst_ip}",
                    "dst_port": "443",
                    "ip_protocol": "tcp",
                    "app_protocol": "github-downloading",
                    "fw_action": "allow"
                },
                {
                    "operation": "log",
                    "type": "ngfw-threat",
                    "params": {
                        "subtype": "ml-virus",
                        "source_ip": "{src_ip}",
                        "source_user": null,
                        "source_port": "{src_port}",
                        "dest_ip": "{dst_ip}",
                        "dest_port": "443",
                        "protocol": "tcp",
                        "app": "github-downloading",
                        "app_category": "saas",
                        "app_sub_category": "management",
                        "threat_name": "Malicious PowerShell Script",
                        "threat_category": "powershell1",
                        "direction": "server to client",
                        "misc": "xma.g00g1e.net/xp101t.ps1"
                    }
                }
            ]
        },
        {
            "#": "Malicious PowerShell Script [Outside Proxy]",
            ".interval": "{random.randint(43200, 86400)}",
            ".variables": {
                "src_ip": "{_corp_client_segment_ip_prefix}.{random.randint(10, 14)}",
                "src_port": "{random.randint(10000, 65534)}",
                "dst_ip": "{ipaddress.IPv4Address(random.randint(0x01000001, 0x09ffff00))}",
                "dst_path": "{''.join(random.choices(string.ascii_lowercase, k=4))}/{''.join(random.choices(string.ascii_lowercase + '_', k=8))}.ps1",
                "proxy_ip": "{_corp_client_segment_ip_prefix}.250"
            },
            "sources": [
                {
                    "operation": "internal.outbound",
                    "type": "network",
                    "src": "{src_ip}",
                    "src_port": "{src_port}",
                    "src_user": null,
                    "src_host": null,
                    "src_domain": null,
                    "dst": "{dst_ip}",
                    "dst_port": 80,
                    "ip_protocol": "tcp",
                    "app_protocol": "http",
                    "fw_action": "allow",
                    "http": {
                        "default": {
                            "user_agent": "SLPLoader",
                            "req_method": "GET",
                            "req_version": "HTTP/1.1",
                            "resp_status": 200,
                            "resp_bytes": "{random.randint(1024 * 1024, 10 * 1024 * 1024)}"
                        },
                        "dst": [
                            "http://{dst_ip}/{dst_path}"
                        ]
                    },
                    ".wait": 10
                },
                {
                    "operation": "log",
                    "type": "ngfw-threat",
                    "params": {
                        "subtype": "ml-virus",
                        "source_ip": "{proxy_ip}",
                        "source_user": null,
                        "source_port": "{src_port}",
                        "dest_ip": "{dst_ip}",
                        "dest_port": 80,
                        "protocol": "tcp",
                        "app": "web-browsing",
                        "app_category": "general-internet",
                        "app_sub_category": "internet-utility",
                        "threat_name": "Malicious PowerShell Script",
                        "threat_category": "powershell1",
                        "direction": "server to client",
                        "misc": "{dst_ip}/{dst_path}"
                    }
                }
            ]
        },
        {
            "#": "A Successful VPN connection from TOR - Cisco AnyConnect VPN (May require syslog ingestion)",
            ".interval": "{random.randint(43200, 86400)}",
            "sources": {
                ".variables": {
                    "user": "{random.choice(list(__users))}",
                    "tor_ip": "{random.choice(['171.25.193.25','80.67.167.81','192.42.116.187','198.98.51.189','89.58.26.216','109.70.100.4','149.56.22.133'])}"
                },
                "operation": "log",
                "type": "custom",
                "cef_version": "0",
                "cef_vendor": "Cisco",
                "cef_product": "ASA",
                "log_format": "raw",
                "log_params": "%ASA-6-113039: Group <grp-policy> User <{user}> IP <{tor_ip}> AnyConnect parent session started."
            }
        }
    ]
}